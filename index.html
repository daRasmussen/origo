<!DOCTYPE html>
<html lang="sv">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1">
	<title>K3-test</title>
	<link href="css/style.css" rel="stylesheet">
</head>
<body>
	<object id="LL" style="LEFT: 0px; WIDTH: 1px; TOP: 0px; HEIGHT: 1px" height="1" width="1" classid="clsid:5C8DA1E0-AF18-4724-A15A-1ED9FC42D493" viewastext="">
		<param name="_ExtentX" value="4048">
		<param name="_ExtentY" value="529">
  </object>
<div id="app-wrapper"></div>
<script type="text/javascript" src="js/origo.js"></script>
<script type="text/javascript">
	//Init origo
  origo.map.init('index.json');
	var landlord = (function(){
			var url = "http://kartportal.vasteras.se/services/gisela/v2";
			var identifiedObjects = [];
			var zoomToFeatures = false;
			var layerId;
			var trustees;
			var noOfCallsOnLandlord = 0;
			var digitForm;
			var digitButton;
			var updateButton;
			var coordLabel;
			var xCoord;
			var yCoord;
			var digitTool;
			var digitObjectId;
			var digitObjectPurpose;

			return {
				identifyObjects : function(results, MapServiceNo_FK, zoomToFeatures) {
					this.identifiedObjects = results;
					this.zoomToFeatures = zoomToFeatures;
					var objectIds = "";
					var foundIds = [];

					for (var i = 0; i < results.length; i++) {

						// Villkoret !foundIds[parseInt(results[i].feature.attributes["OBJEKTNR"])] �r f�r att kontrollera att samma objektid inte kommer med mer �n en g�ng.
						if (LMF_identifiableLayers[MapServiceNo_FK][results[i].layerId].options  &&  LMF_identifiableLayers[MapServiceNo_FK][results[i].layerId].options.LL_object  &&  !foundIds[parseInt(results[i].feature.attributes["OBJEKTNR"])]) {
							if (objectIds.length != 0) objectIds += ",";
							objectIds += results[i].feature.attributes["OBJEKTNR"];
							foundIds[parseInt(results[i].feature.attributes["OBJEKTNR"])] = true;
						}
					}
					if (objectIds == "") { // Om identifieringen gjorts p� enbart icke-Landlord-lager
						LMF_addToIdentifyTabPanel(results, MapServiceNo_FK);
					}
					else {
						// H�r s�tts anropet till Gisela-servicen vid identifiering. Om kontrakt ska h�mtas �ndras 'detailed' till 'complete'.
						this.getObjects({ ids: objectIds, filter: "detailed" }, function(LL_objects) {
	//															console.log("-----------------------------------------------------");
	//															console.dir(LL_objects);
																for (var i = 0;i < LL_objects.length; i++) {
																	var LL_id = LL_objects[i].id;
																	for (var j = 0; j < landlord.identifiedObjects.length; j++) {
																		if (landlord.identifiedObjects[j].feature.attributes["OBJEKTNR"] == LL_id) {
																			landlord.identifiedObjects[j].feature.attributes = landlord.merge_objects(landlord.identifiedObjects[j].feature.attributes, LL_objects[i]);
																		}
																	}
																}
																LMF_addToIdentifyTabPanel(landlord.identifiedObjects, MapServiceNo_FK);
																if (zoomToFeatures) {
																	var geometries = [];
																	for (var i = 0; i < landlord.identifiedObjects.length; i++) {
																		geometries[i] = landlord.identifiedObjects[i].feature.geometry;
																	}
																	LMF_zoomToGeometries(geometries, 3.0);
																}
															});
					}
				},

				findObjects : function(objects) {
					selWin.setLoading(false);
					if (objects.length == 0) {
						Ext.Msg.alert('Inget resultat!', 'S&ouml;kningen gav inga tr&auml;ffar.');
					}
					else {
						for (var i = 0; i < objects.length; i++) {
							var layerIds = Fk_getLayerNosForPurpose(objects[i].purpose);

							// Tilldelar endast det f�rsta funna layerId som, i de fall det �r tv� layerId �r punktlagret.
							if (layerIds) {
								objects[i].layerId = layerIds[0];
							}
							else {
								Ext.Msg.alert('Fel i data!', '&Auml;ndam&aring;l ej definierat. Objektet kommer inte att visas i resultatet.<br />Kontakta administrat&ouml;r.<br /><br />&Auml;ndam&aring;l : ' + objects[i].purpose + '<br />Objekt : ' + objects[i].id);
								objects.splice(i, 1);
							}
						}

						// Sorterar objekten p� lagerId
						objects.sort(function(a,b){
						  var aString = eval("a.layerId");
						  var bString = eval("b.layerId");

						  if (aString < bString) return -1;
						  else if (aString > bString) return 1;
						  else return 0;
						});

						LMF_addToIdentifyTabPanel(objects, MapServiceNo_FK, "LL_task");

					}
				},

				// H�mtar �ndam�l f�r givna LL-objekt. Anropas efter det att parameteranrop fr�n Landlord gjorts
				getAndamalForLLObjects : function(objectId) {
					selWin.setLoading(true);
					var queryTask = new esri.tasks.QueryTask("http://kartportal.vasteras.se/ArcGIS/rest/services/int/fk_kartportal_dyn/MapServer/0");
					var query = new esri.tasks.Query();
					query.where = "OBJEKTNR=" + objectId;
					query.outSpatialReference = {wkid:3010};
					query.returnGeometry = false;
					query.outFields = ["OBJEKTNR", "ANDAMAL"];

					queryTask.execute(query, function(featureSet) {
													  var purposeId = featureSet.features[0].attributes.ANDAMAL;
													  var objectId = featureSet.features[0].attributes.OBJEKTNR;
													  var layerIds = Fk_getLayerNosForPurposeId(purposeId);

													  landlord.getGeometriesForLLObjects(objectId, layerIds);
													  }, function(error) {//alert("Fel i applikation. Error 1212. Kontakta LMF");
													  });
				},

				// H�mtar geometrier f�r valda LL-objekt.
				getGeometriesForLLObjects : function(objectId, layerIds) {
					selWin.setLoading(true);

					var grid = resultPanel.getActiveTab();
					if (layerIds) {
						landlord.layerId = layerIds[0];
					}
					else {
						landlord.layerId = grid.layerId;
					}
					var objectList = "";

					if (objectId) {
						objectList += objectId;
					}
					else {
						for (var i = 0; i < grid.getSelectionModel().getSelection().length; i++) {
							if (objectList.length != 0) objectList += ",";
							objectList += grid.getSelectionModel().getSelection()[i].get('Objekt');
						}
					}
					var queryTask = new esri.tasks.QueryTask("http://kartportal.vasteras.se/ArcGIS/rest/services/int/fk_kartportal_dyn/MapServer/" + landlord.layerId);
					var query = new esri.tasks.Query();
					query.where = "OBJEKTNR IN (" + objectList + ")";

					query.outSpatialReference = {wkid:3010};
					query.returnGeometry = true;
					query.outFields = ["OBJEKTNR"];

					queryTask.execute(query, landlord.showLLObjectsInMap);
				},

				// Funktion f�r att hitta arrendeytor som tillh�r givet punktobjekt.
				identifyAndzoomToArrenden : function () {
					selWin.setLoading(true);

					var grid = resultPanel.getActiveTab();
					landlord.layerId = grid.layerId;
					landlord.layerId = Math.max(landlord.layerId, LMF_identifiableLayers[MapServiceNo_FK][landlord.layerId].options.refLayer); // V�ljer st�rsta layerId eftersom det �r lagret med ytor.
					var objectList = grid.getSelectionModel().getSelection()[0].get('Objekt');

					var queryTask = new esri.tasks.QueryTask("http://kartportal.vasteras.se/ArcGIS/rest/services/int/fk_kartportal_dyn/MapServer/" + landlord.layerId);
					var query = new esri.tasks.Query();
					query.where = "OBJEKTNR IN (" + objectList + ")";
					query.outSpatialReference = {wkid:3010};
					query.returnGeometry = true;
					query.outFields = ["OBJEKTNR"];
					queryTask.execute(query, landlord.showLLObjectsInMap);

	/*				var grid = resultPanel.getActiveTab();

					if (grid.getSelectionModel().getCount() == 1) {
						console.log("-------------------------------------");
						console.log(grid.getSelectionModel().getSelection()[0].get('Objekt'));
						console.log("-------------------------------------");
						console.dir(grid.getSelectionModel().getSelection()[0]);
						LMF_zoomToGeometry(grid.getSelectionModel().getSelection()[0].get('graphic').geometry);
					}
					else if (grid.getSelectionModel().getCount() > 1) {
							for (var i = 0; i < grid.getSelectionModel().getSelection().length; i++) {
								fnrList[i] = grid.getSelectionModel().getSelection()[i].get('Fnr');
							}
					}
					else {
				//		fnrList = grid.getStore().collect('Fnr');
					}*/
				},

				//Visar valda LLobjekt
				// Tar omv�gen att p� nytt anropa Giselaservicen via landlord.identifyObjects eftersom den funmktionen redan har funktionalitet klar.
				showLLObjectsInMap : function (featureSet) {
					if (featureSet.features.length == 0) {
						Ext.Msg.alert('Inget resultat!', 'Inga objekt returnerade.');
						selWin.setLoading(false);
					}
					else {
						LMF_setLayerVisible(MapServiceNo_FK, landlord.layerId, true);

						LMF_resetSelection();
						map.graphics.clear();

						var findResults = [];
						for (var i = 0; i < featureSet.features.length; i++) {
							findResults[i] = new Object();
							findResults[i].layerId = landlord.layerId;
							findResults[i].feature = featureSet.features[i];
						}

						landlord.identifyObjects(findResults, MapServiceNo_FK, true);
					}
				},

				// Funktion som anropas d� parameteranrop p� karttj�nsten gjorts fr�n Landlord f�r att visa givet objekt.
				zoomToLLObject : function (objectId) {
					LMF_showLoading();
					landlord.getAndamalForLLObjects(objectId);
				},

				// Funktion som anropas d� parameteranrop p� karttj�nsten gjorts fr�n Landlord f�r digitalisera objekt.
				digitLLObject : function (objectId, purpose) {
					landlord.digitObjectId = objectId;
					landlord.digitObjectPurpose = purpose;
					var htmltext = '<table cellspacing="10" height="150" width="250">';
					htmltext += '<tr><td>&nbsp;</td><td>&nbsp;</td></tr>';
					htmltext += '<tr><td valign="top">&nbsp;1.&nbsp;</td><td valign="top">Navigera i kartan till den plats d&auml;r objektet ska ligga. Anv&auml;nd g&auml;rna snabbs&ouml;k.</td></tr>';
					htmltext += '<tr><td valign="top">&nbsp;2.&nbsp;</td><td valign="top">Klicka p&aring; knappen "Digitalisera".</td></tr>';
					htmltext += '<tr><td valign="top">&nbsp;3.&nbsp;</td><td valign="top">Klicka i kartan p&aring; den plats som objektet ska ligga.</td></tr>';
					htmltext += '<tr><td valign="top">&nbsp;4.&nbsp;</td><td valign="top">Bekr&auml;fta genom att klicka p&aring; knappen "Uppdatera", alternativt korrigera genom att b&ouml;rja om fr&aring;n punkt 1 eller 2.</td></tr>';
					htmltext += '<tr><td>&nbsp;</td><td>&nbsp;</td></tr>';
					htmltext += '<tr><td colspan="2" valign="top">&nbsp;F&ouml;r att avbryta digitaliseringen klickar du p&aring; &nbsp;knappen "Avbryt".</td></tr>';
					htmltext += '<tr><td>&nbsp;</td><td>&nbsp;</td></tr>';
					htmltext += '</table>';

					digitForm = Ext.create('widget.window', {
						title: 'Digitalisera Landlordobjekt',
						id: 'LL_digitform',
						closable: false,
						collapsible: true,
						width: 265,
						height: 380,
						resizable: false,
						x: 450,
						y: 160,
						listeners: {
						},
						items: [
							Ext.create('Ext.panel.Panel', {
								width: 255,
								html: htmltext,
							}),
							Ext.create('Ext.form.Label', {
								width: 250,
								html: '<div id="newObjectId" style="margin:10px 10px 5px 25px">Objekt:&nbsp;' + landlord.digitObjectId + '</div>',
							}),
							landlord.digitButton = Ext.create('Ext.Button', {
								scale: 'small',
								width: 80,
								text: 'Digitalisera',
								enableToggle: true,
								margin: '10 10 10 25',
								iconCls: 'toolbutton_LL_digitise',
								iconAlign:'top',
								cls: 'toolButton',
								handler: landlord.activateDigitising
							}),
							landlord.updateButton = Ext.create('Ext.Button', {
								scale: 'small',
								width: 80,
								text: 'Uppdatera',
								margin: '10 30 10 25',
								iconCls: 'toolbutton_LL_update',
								iconAlign:'top',
								cls: 'toolButton',
								disabled : true,
								handler: landlord.updateDigitising
							}),
							landlord.coordLabel = Ext.create('Ext.form.Label', {
								width: 190,
								html: '<div id="LL_coord" style="width:109px;margin:10px 3px 10px 25px;float:left">N: <br />E: </div>',
							}),
	/*						landlord.yLabel = Ext.create('Ext.form.Label', {
								width: 190,
								html: '<div id="LL_y" style="margin:10px 10px 10px 50px">y:</div>',
							}),*/
							Ext.create('Ext.Button', {
								scale: 'small',
								width: 80,
								text: 'Avbryt',
								margin: '5 10 10 3',
								iconCls: 'toolbutton_LL_abort',
								iconAlign:'top',
								cls: 'toolButton',
								handler: landlord.abortDigitising
							})
						]
					}).show();
				},

				activateDigitising : function () {
					LMF_identifyEnabled = false;
					landlord.digitButton.setLoading("Digitalisera...");
					map.setCursor("crosshair");
					digitTool = new esri.toolbars.Draw(map);
					dojo.connect(digitTool, "onDrawEnd", landlord.finishDigitising);
					esri.bundle.toolbars.draw.addPoint = "Klicka i kartan d&auml;r objektet ska ligga.";
					digitTool.activate(esri.toolbars.Draw.POINT);
				},
				finishDigitising : function (geometry) {
					map.graphics.clear();
					landlord.digitButton.setLoading(false);
					map.setCursor("default");

					var	positionSymbol = new esri.symbol.PictureMarkerSymbol("./commonfiles/images/digitise.png", 16, 16);
					currentPoint = geometry;
					landlord.xCoord = Math.round(currentPoint.x);
					landlord.yCoord = Math.round(currentPoint.y);
					landlord.coordLabel.setText('<div id="LL_coord" style="width:109px;margin:10px 3px 10px 25px;float:left">N: ' + landlord.yCoord + '<br />E: ' + landlord.xCoord + '</div>', false);
					var graphic = map.graphics.add(new esri.Graphic(geometry, positionSymbol));

					digitTool.deactivate();
					landlord.updateButton.setDisabled(false);
					LMF_identifyEnabled = true;
				},
				updateDigitising : function () {
					LMF_showLoading(true);
					console.log("landlord.digitObjectId = " +landlord.digitObjectId);
					console.log("landlord.digitObjectPurpose = " + landlord.digitObjectPurpose);
					console.log("landlord.yCoord = " + landlord.yCoord);
					console.log("landlord.xCoord = " + landlord.xCoord);
					var tmpPurpose = parseInt(landlord.digitObjectPurpose, 10);
					console.log("tmpPurpose = " + tmpPurpose);
	//				console.log("Tar bort objektet : " + http://kartportal.vasteras.se/services/giselaExchange/exchange.ashx?type=VaskanRadering&fid=11116)

	// Kontrollerar om objektet redan finns
	var queryTask = new esri.tasks.QueryTask("http://kartportal.vasteras.se/ArcGIS/rest/services/int/fk_kartportal_dyn/MapServer/0");
					var query = new esri.tasks.Query();
					query.where = "OBJEKTNR=" + landlord.digitObjectId;
					query.outSpatialReference = {wkid:3010};
					query.returnGeometry = false;
					query.outFields = ["OBJEKTNR"];

					queryTask.execute(query, function(featureSet) {
						if (featureSet.features.length == 0) { // Objektet finns inte sedan tidigare
							landlord.updateGeometry(parseInt(landlord.digitObjectId), {purpose:tmpPurpose, n: parseInt(landlord.yCoord),e: parseInt(landlord.xCoord)}, function(info) {
								LMF_hideLoading();
								console.dir(info);
								if (info.created  ||  info.updated) {
									map.graphics.clear();
									digitForm.setVisible(false);
									Ext.MessageBox.alert('Digitalisering genomf&ouml;rd.', 'Objektets koordinater &auml;r nu uppdaterade i kartdatabasen. G&aring; tillbaka och uppdatera objektets koordinater i Landlord.', function () {window.open('http://kartportal.vasteras.se/portal/default.htm?option=LL&objectid=' + landlord.digitObjectId, '_self');});
								}
								else {
									Ext.Msg.alert('Digitalisering avbruten.', 'Gick ej att uppdatera koordinater i kartdatabasen. Kontakta LMF.');
								}
							});
						}
						else { // Objektet finns sedan tidigare.
							landlord.updateGeometry(parseInt(landlord.digitObjectId), {purpose:tmpPurpose, n: parseInt(landlord.yCoord),e: parseInt(landlord.xCoord)}, function(info) {
								LMF_hideLoading();
								console.dir(info);
								if (info.created  ||  info.updated) {
									map.graphics.clear();
									digitForm.setVisible(false);
									Ext.MessageBox.alert('Digitalisering genomf&ouml;rd.', 'Objektets koordinater &auml;r nu uppdaterade i kartdatabasen. G&aring; tillbaka och uppdatera objektets koordinater i Landlord.', function () {window.open('http://kartportal.vasteras.se/portal/default.htm?option=LL&objectid=' + landlord.digitObjectId, '_self');});
								}
								else {
									Ext.Msg.alert('Digitalisering avbruten.', 'Gick ej att uppdatera koordinater i kartdatabasen. Kontakta LMF.');
								}
							});
						}

					}, function(error) {alert("Fel i applikation. Error 112. Kontakta LMF");});
				},
				abortDigitising : function () {
					console.log("abortDigitising");
					Ext.MessageBox.buttonText.yes = "Ja";
					Ext.MessageBox.buttonText.no = 'Nej';
					Ext.MessageBox.confirm('Avbryta digitalisering', 'Vill du avbryta digitaliseringen och st&auml;nga f&ouml;nstret?', function(confirmed) {
					 console.log("confirmed = " + confirmed);
						if (confirmed == 'yes') {
							window.close();
						}
					});
				},

				configSearchPnl : function () {
					if (!landlord.trustees) {
						selWin.setLoading(true);
						landlord.getTrustees(function (trustees) {
								landlord.noOfCallsOnLandlord++;
								if (trustees) {
									landlord.trustees = trustees;
									landlord.trustees.unshift({name: '--Alla--', id: '*'});
									selWin.setLoading(false);
								}
								else {
									if (landlord.noOfCallsOnLandlord < 5) {
										setTimeout(landlord.configSearchPnl(), 3000);
									}
									else {
										selWin.setLoading(false);
										alert("Inget svar fr&aring;n Landlord. Full Landlordfunktionalitet kan inte garanteras. Kontakta LMF alternativt systemansvarig f�r Landlord.");
									}
								}
								cmbLandlordTrustees.store.loadData(landlord.trustees);
								cmbLandlordTrustees.setValue('*');
								txtSearchText.setDisabled(true);
						});
					}
					else {
						cmbLandlordTrustees.store.loadData(landlord.trustees);
						cmbLandlordTrustees.setValue('*');
						txtSearchText.setDisabled(true);
					}
				},

				/**
				 * Overwrites obj1's values with obj2's and adds obj2's if non existent in obj1
				 * @param obj1
				 * @param obj2
				 * @returns obj3 a new object based on obj1 and obj2
				 */
				merge_objects : function(obj1,obj2) {
					var obj3 = {};
					for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
					for (var attrname in obj2) { obj3[attrname] = obj2[attrname]; }
					return obj3;
				},

				// Funktioner f�r anrop mot webservice Gisela. Levererade av Tom.
				updateGeometry : function(id, obj, callback) {
					console.log("----- In updateGeometry -------");
					console.log(JSON.stringify(obj));
					console.dir(JSON.stringify(obj));
						request({
							url : url + "/geometries/" + id,
							method : "PUT",
							body : JSON.stringify(obj),
							json : true
						}, function(error, response, body) {
							/*console.log("error", error);
							console.log("response",response);
							console.log("body", body);*/
							if(error === null){
								if(body === ""){
									body = {};
								}
								if(response.status === 200){
									body.updated = true;
								}
								if(response.status === 201){
									body.created = true;
								}
							}
							callback(body);
						});
					},

				getTrustees : function(callback) {

						request({
							url : url + "/trustees",
							method : "GET",
							json : true
						}, function(error, response, body) {
							//console.log("error", error);
							//console.log("response",response);
							if(response.status === 200){
								//console.log("body", body);
								callback(body);
							} else {
								callback(null);
							}
						});
					},


				getObjects : function(filter, callback) {
						var queryParams = [], query = "";
						if(callback === undefined){
							callback = filter;
							filter = undefined;
						}
						if(typeof filter === "object"){
							if(filter.theme !== undefined){
								queryParams.push("theme=" + filter.theme);
							}
							if(filter.purpose !== undefined){
								queryParams.push("purpose=" + filter.purpose);
							}
							if(filter.trustee !== undefined){
								queryParams.push("trustee=" + filter.trustee);
							}
							if(filter.ids !== undefined ){
								queryParams.push("ids=" + filter.ids);
							}
							if(filter.filter !== undefined ){
								queryParams.push("filter=" + filter.filter);
							}
							if(queryParams.length >0){
								query = "?" + queryParams.join("&");
							}

						}
						request({
							url : url + "/objects" + query,
							method : "GET",
							json : true
						}, function(error, response, body) {
							//console.log("error", error);
							//console.log("response",response);
							if(response.status === 200){
								//console.log("body", body);
								callback(body);
							} else {
								callback(null);
							}
						});
					},
				getObject : function(id, callback) {
						request({
							url : url + "/objects/" + id,
							method : "GET",
							json : true
						}, function(error, response, body) {
							//console.log("error", error);
							//console.log("response",response);
							if(response.status === 200){
								//console.log("body", body);
								callback(body);
							} else {
								callback(null);
							}
						});
					},
				goToLandlord : function() {
						// var grid = resultPanel.getActiveTab();
						// var objectId = grid.getSelectionModel().getSelection()[0].get('Objekt');
						objectId = 5911
						console.log("LL objectId : " + objectId);
						LL.Hidden = false;
						LL.IsDebug = true;
						//LL.BackColor = "#CCCCCC"
						LL.StartLandlord = true;
						LL.LLPATH = "\\\\srv01078f\\ll$\\Landlord\\GiselaStart";
						LL.LLTimeOut = 200;
						//LL.LLPort = 40000
						LL.ShowInLL(objectId, 'forvobj');
					},
				};
	}());

		// This is what you do to consume the above api
		landlord.getObject(43011,function(object){
			console.log("---------------GET OBJECT 43011------------------");
			console.dir(object);
		});

		landlord.getObjects(function(objects) {
			console.log("---------------GET ALL OBJECTS------------------");
			console.dir(objects);
		});

		landlord.getObjects({trustee: "fkag01"}, function(objects){
			console.log("---------------GET ALL OBJECTS------------------");
			console.log("------------WHERE TRUSTEE fkag01----------------");
			console.dir(objects);
		});

		landlord.getObjects({purpose: "007"}, function(objects){
			console.log("---------------GET ALL OBJECTS------------------");
			console.log("------------WHERE PURPOSE 007----------------");
			console.dir(objects);
		});

		landlord.getObjects({purpose: "009", trustee: "fkag01"}, function(objects){
			console.log("---------------GET ALL OBJECTS------------------");
			console.log("------------WHERE PURPOSE 009----------------");
			console.log("------------AND TRUSTEE fkag01 ----------------");
			console.dir(objects);
		});

		landlord.getObjects({ids: "54138,55048"}, function(objects){
			console.log("---------------GET ALL OBJECTS------------------");
			console.log("------------WHERE id = 54138 or 55048----------------");
			console.dir(objects);
		});
		landlord.getObjects({theme: "sarskilda_bostader"}, function(objects){
			console.log("---------------GET ALL OBJECTS------------------");
			console.log("------------WHERE theme = sarskilda_bostader----------------");
			console.dir(objects);
		});

		landlord.getTrustees(function(trustees){
			console.log("---------------GET ALL TRUSTEES------------------");
			console.dir(trustees);
		});
		landlord.updateGeometry(5051, {purpose:7, n: 500000,e: 23344455}, function(info) {
			console.log("---------------UPDATED GEOMETRY-----------------");
			console.dir(info);
		});

	Ext.onReady(function() {
		// Modell f�r nedrullningslistor
		Ext.define('Fk_trusteeModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'name', type: 'string'},
				{name: 'id', type: 'string'}
				]
		});
		Ext.define('Fk_layerModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'label', type: 'string'},
				{name: 'id', type: 'string'},
				{name: 'layerIds', type: 'auto'}
				]
		});
		Ext.define('Fk_purposeModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'label', type: 'string'},
				{name: 'id', type: 'string'}
				]
		});


		// H�gerklickmenyn f�r arrenden.
		Fk_contextMenuArrende  = new Ext.menu.Menu({
			items: [
				{
				  text: 'Visa tillh&ouml;rande ytor',
				  itemId: 'arrendeFunction',
				  handler: function() {landlord.identifyAndzoomToArrenden();}
				},
				'-',
				{
				  text: 'Zooma till',
				  itemId: "zoom_to",
				  handler: function() {LMF_zoomToFeatures();}
				},
				'-', {
					text: 'Skriv ut',
					handler: function() {LMF_printTableRecords();}
				},
				'-', {
					text: 'Rensa urval',
					handler: function () {LMF_resetSelection();}
				},
				'-', {
					text: 'Visa i Landlord',
					itemId: 'LLFunction',
					handler: function () {landlord.goToLandlord();}
				}
			]
		});
		// H�gerklickmenyn f�r LL-objekt med geometrier.
		Fk_contextMenuLLObject  = new Ext.menu.Menu({
			items: [
				{
				  text: 'Zooma till',
				  itemId: "zoom_to",
				  handler: function() {LMF_zoomToFeatures();}
				},
				'-', {
					text: 'Skriv ut',
					handler: function() {LMF_printTableRecords();}
				},
				'-', {
					text: 'Rensa urval',
					handler: function () {LMF_resetSelection();}
				},
				'-', {
					text: 'Visa i Landlord',
					itemId: 'LLFunction',
					handler: function () {landlord.goToLandlord();}
				}
			]
		});
		// H�gerklickmenyn f�r LL-objekt utan geometrier.
		Fk_contextMenuLLObjectList  = new Ext.menu.Menu({
			items: [
				{
				  text: 'Visa i kartan',
				  handler: function() {landlord.getGeometriesForLLObjects();}
				},
				'-', {
					text: 'Skriv ut',
					handler: function() {LMF_printTableRecords();}
				},
				'-', {
					text: 'Rensa urval',
					handler: function () {LMF_resetSelection();}
				},
				'-', {
					text: 'Visa i Landlord',
					itemId: 'LLFunction',
					handler: function () {landlord.goToLandlord();}
				}
			]
		});

		//Definiera lista �ver f�rvaltare
		Fk_trusteesStore = Ext.create('Ext.data.Store', {
			model: 'Fk_trusteeModel',
			data: [{name: '--Alla--', id: '0'}]
		});

		//Definiera lista �ver �ndam�l
		Fk_purposesList = [{label:'--Alla--',				id:'*'},
					{label:'000 Sommarbostad',					id:'000'},
					{label:'001 Driftavtal', 					id:'001'},
					{label:'002 Servicehus', 					id:'002'},
					{label:'003 \u00C5lderdomshem', 			id:'003'},
					{label:'004 Kontor', 						id:'004'},
					{label:'005 Gruppboende', 					id:'005'},
					{label:'006 Korttidsboende (Sjukhem)', 		id:'006'},
					{label:'007 Bostadsarrende', 				id:'007'},
					{label:'008 Elevbostad', 					id:'008'},
					{label:'009 Servicebostad',		 			id:'009'},
					{label:'010 F\u00F6reningslokal', 			id:'010'},
					{label:'011 Grundskola', 					id:'011'},
					{label:'012 Gymnasieskola', 				id:'012'},
					{label:'013 Kulturell lokal', 				id:'013'},
					{label:'014 F\u00F6rskola', 				id:'014'},
					{label:'015 Industrilokal', 				id:'015'},
					{label:'016 \u00D6vrig skollokal', 			id:'016'},
					{label:'017 Bost\u00E4der barn och ungdom LSS', 					id:'017'},
					{label:'018 Bost\u00E4der vuxna SoL',		id:'018'},
					{label:'019 Bibliotek', 					id:'019'},
					{label:'020 Gruppbostad', 					id:'020'},
					{label:'021 Servering', 					id:'021'},
					{label:'022 Skyddsrum', 					id:'022'},
					{label:'023 Parklek', 						id:'023'},
					{label:'024 Personallokal', 				id:'024'},
					{label:'025 P-plats', 						id:'025'},
					{label:'026 Idrottshall', 					id:'026'},
		//			{label:'027 Brand\u00F6vning', 				id:'027'},
					{label:'028 Reklamskylt',	 				id:'028'},
					{label:'029 Kiosk',		 					id:'029'},
					{label:'030 Bensinstation', 				id:'030'},
		//			{label:'031 \u00D6vrig nyttjander\u00E4tt', id:'031'},
					{label:'031 \u00D6vrigt',					 id:'031'},
					{label:'032 Bostad',	 					id:'032'},
					{label:'033 Obebyggd fastighet', 			id:'033'},
					{label:'035 Lokal', 						id:'035'},
		//			{label:'036 Verkstad', 						id:'036'},
		//			{label:'038 Tv\u00E4ttinr\u00E4ttning', 	id:'038'},
					{label:'039 Odlingslott',	 				id:'039'},
					{label:'040 Fritid', 						id:'040'},
					{label:'041 Fiske',		 					id:'041'},
					{label:'042 Jakt',		 					id:'042'},
					{label:'043 Bete', 		 					id:'043'},
					{label:'044 Jordbruk', 						id:'044'},
		//			{label:'045 Garage', 						id:'045'},
					{label:'046 Socialt \u00E4ndam\u00E5l',		id:'046'},
					{label:'047 HVB Hem',						id:'047'},
					{label:'048 Idrottsanl\u00E4ggning', 		id:'048'},
					{label:'049 Ishall', 						id:'049'},
					{label:'050 Campingplats', 					id:'050'},
					{label:'051 Ridanl\u00E4ggning', 			id:'051'},
					{label:'052 Simhall', 						id:'052'},
					{label:'053 Golfbana', 						id:'053'},
					{label:'054 Korttidsboende', 				id:'054'},
		//			{label:'055 Gruppbostad', 					id:'055'},
					{label:'056 Hemtj\u00E4nstlokal', 			id:'056'},
					{label:'057 Daglig verksamhet', 			id:'057'},
		//			{label:'058 Syssels\u00E4ttningsverksamhet',id:'058'},
					{label:'059 M\u00F6tesplats/Tr\u00E4ffpunkt',id:'059'},
		//			{label:'060 Rehab', 						id:'060'},
					{label:'064 Konstfrusen isbana', 			id:'064'},
					{label:'065 Mast', 							id:'065'}
				   ];

		Fk_purposesStore = Ext.create('Ext.data.Store', {
			model: 'Fk_purposeModel',
			data: Fk_purposesList
		});

		//Definiera lista �ver lager
		Fk_layersList = [
				{label:"--Alla--", id: "*", layerIds: []},
				{label:"Skolor och f\u00F6rskolor", id: "011, 012, 014, 016", layerIds: [fk_skolor_forskolor]},
				{label:"Bost\u00E4der", id: "000, 032", layerIds: [fk_bostader]},
				{label:"S\u00E4rskilda bost\u00E4der", id: "002,003,005,006,008,009,017,018,046,054,055,056,057,058,059,060", layerIds: [fk_sarskilda_bostader]},
				{label:"Lokaler", id: "004,010,015,021,022,023,024,027,035,036,038", layerIds: [fk_lokaler]},
				{label:"Idrotts- och Fritidsanl\u00E4ggningar", id: "026,040,048,049,050,051,052,053,064", layerIds: [fk_idrott_fritid]},
				{label:"Kulturlokaler", id: "013,019", layerIds: [fk_kulturlokaler]},
				{label:"Bensinarrenden", id: "030", layerIds: [fk_bensinarrende_pkt, fk_bensinarrende]},
				{label:"Bostadsarrenden", id: "007", layerIds: [fk_bostadsarrende_pkt, fk_bostadsarrende]},
				{label:"Fiskearrenden", id: "041", layerIds: [fk_fiskearrende_pkt, fk_fiskearrende]},
				{label:"Jaktarrende", id: "042", layerIds: [fk_jaktarrende_pkt, fk_jaktarrende]},
				{label:"Jordbruksarrenden", id: "043,044", layerIds: [fk_jordbruksarrende_pkt, fk_jordbruksarrende]},
				{label:"Kioskarrenden", id: "029", layerIds: [fk_kioskarrende_pkt, fk_kioskarrende]},
				{label:"Parkeringsarrenden", id: "025", layerIds: [fk_parkeringsarrende_pkt, fk_parkeringsarrende]},
				{label:"\u00D6vriga arrenden", id: "028,031,039,065", layerIds: [fk_ovrigt_arrende_pkt, fk_ovrigt_arrende]},
				{label:"Obebyggd mark", id: "033", layerIds: [fk_obebyggd_mark]}
				];
		Fk_layersStore = Ext.create('Ext.data.Store', {
			model: 'Fk_layerModel',
			data: Fk_layersList
		});
	});


	// Funktion som vid anrop konfigurerar och visar h�gerklicksmenyn f�r arrenden.
	function Fk_configureAndShowContextMenuArrende(coords) {
		Fk_contextMenuArrende.getComponent('arrendeFunction').setDisabled(!(resultPanel.getActiveTab().getSelectionModel().getCount() == 1));
		Fk_contextMenuArrende.getComponent('LLFunction').setDisabled(!(resultPanel.getActiveTab().getSelectionModel().getCount() == 1));
		Fk_contextMenuArrende.getComponent('zoom_to').setDisabled(!(resultPanel.getActiveTab().getSelectionModel().hasSelection()));
		Fk_contextMenuArrende.showAt(coords);
	}
	// Funktion som vid anrop konfigurerar och visar h�gerklicksmenyn f�r LL-objekt.
	function Fk_configureAndShowContextMenuLLObjects(coords) {
		if (!resultPanel.getActiveTab().includesGraphics) { // Om inte resultattabellens aktiva tab/grid inneh�ller geometrier (grafik) s� �r det LLobjekt som �nnu ej visas i kartan
			Fk_contextMenuLLObjectList.getComponent('LLFunction').setDisabled(!(resultPanel.getActiveTab().getSelectionModel().getCount() == 1));
			Fk_contextMenuLLObjectList.showAt(coords);
		}
		else if (resultPanel.getActiveTab().options.multiPoly) {
			Fk_contextMenuArrende.getComponent('arrendeFunction').setDisabled(!(resultPanel.getActiveTab().getSelectionModel().getCount() == 1));
			Fk_contextMenuArrende.getComponent('LLFunction').setDisabled(!(resultPanel.getActiveTab().getSelectionModel().getCount() == 1));
			Fk_contextMenuArrende.getComponent('zoom_to').setDisabled(!(resultPanel.getActiveTab().getSelectionModel().hasSelection()));
			Fk_contextMenuArrende.showAt(coords);
		}
		else {
			Fk_contextMenuLLObject.getComponent('LLFunction').setDisabled(!(resultPanel.getActiveTab().getSelectionModel().getCount() == 1));
			Fk_contextMenuLLObject.getComponent('zoom_to').setDisabled(!(resultPanel.getActiveTab().getSelectionModel().hasSelection()));
			Fk_contextMenuLLObject.showAt(coords);
		}
	}

	function selectPurposes(ids) {
		var output = [];
		output.push(Fk_purposesList[0]);

		var ids = ids.split(",");
		if (ids[0] === '*') {
			output = Fk_purposesList.slice();
		}
		else {
			for(var i = 0; i < ids.length; i++){
				for(var a = 0; a < Fk_purposesList.length; a++){
					if(ids[i] === Fk_purposesList[a].id){
						output.push(Fk_purposesList[a]);
					}
				}
			}
		}
		return output;
	}

	// Funktion som returnerar lagerid:n f�r givet purpose i textformat
	function Fk_getLayerNosForPurpose(purpose) {
		var purposeId;
		var layerIds;

		var found = false;
		var i = 0;
		while (!found && i < Fk_purposesList.length) {
			found = Fk_purposesList[i].label.substr(4) == purpose;
			i++;
		}

		if (found) {
			purposeId = Fk_purposesList[i-1].id;
			layerIds = Fk_getLayerNosForPurposeId(purposeId);
		}
		else console.log("\u00C4ndam\u00E5l: " + purpose + " ej definierat.");

		return layerIds;
	}

	// Funktion som returnerar lagerid:n  f�r givet purposeId
	function Fk_getLayerNosForPurposeId(purposeId) {
		purposeId = "" + purposeId;
		if (purposeId.length < 3) {
			purposeId = "0" + purposeId;
			if (purposeId.length < 3) {
				purposeId = "0" + purposeId;
			}
		}

		var layerIds;

		var found = false;
		var j = 0;
		while (!found && j < Fk_layersList.length) {
			var index = Fk_layersList[j].id.search(purposeId);
			if (index > -1) found = true;
			else j++;
		}

		if (found) {
			layerIds = Fk_layersList[j].layerIds;
		}
		else alert("&Auml;ndam&aring;lsid ej definierat. Kontakta LMF.");

		return layerIds;
	}


	function onCmbLandlordLayersSelected(cmb, records, eOpt) {
			cmbLandlordPurpose.store.loadData(selectPurposes(records[0].data.id));
			cmbLandlordPurpose.setValue('*');
	}

	function Fk_searchLandlordItems() {
		var purposeValue;
		var trusteeValue;

		if (cmbLandlordLayers.getValue() === '*'  &&  cmbLandlordPurpose.getValue() === '*'  &&  cmbLandlordTrustees.getValue() === '*') {
			Ext.Msg.alert('S&ouml;kning avbruten', 'Val av lager, &auml;ndam&aring;l och/eller f&ouml;rvaltare &auml;r obligatoriskt.');
		}
		else {
			selWin.setLoading(true);

			// H�mtar val av �ndam�l fr�n dropdownbox.
			if (cmbLandlordPurpose.getValue() != '*') {
				purposeValue = cmbLandlordPurpose.getValue();
			}
			// Om lager valts och inte �ndam�l ger lager valet (lagerobjektet) vilka �ndam�l som ska h�mtas.
			else if (cmbLandlordLayers.getValue() != '*') {
				purposeValue = cmbLandlordLayers.getValue();
			}

			// H�mtar val av f�rvaltare fr�n dropdownbox.
			if (cmbLandlordTrustees.getValue() != '*') trusteeValue = cmbLandlordTrustees.getValue();

			// Anrop p� Giselatj�nsten
			if (purposeValue  &&  trusteeValue) {
				landlord.getObjects({purpose: purposeValue, trustee: trusteeValue, filter: "detailed" }, landlord.findObjects);
			}
			else if (purposeValue) {
				landlord.getObjects({purpose: purposeValue, filter: "detailed" }, landlord.findObjects);
			}
			else if (trusteeValue) {
				landlord.getObjects({trustee: trusteeValue, filter: "detailed" }, landlord.findObjects);
			}
		}
	}
</script>
</body>
</html>
